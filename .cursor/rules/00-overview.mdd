# QR Order Restaurant - Project Overview

## Project Type
Full-stack QR code-based restaurant ordering system with real-time features

## Domain
Restaurant/F&B ordering and management system inspired by Sapo FNB

## Architecture Overview
- **Type**: Monorepo with separate client and server
- **Client**: Next.js 15 (App Router) - Development port 3000
- **Server**: Fastify 4 - Development port 4000
- **Database**: SQLite with Prisma ORM
- **Real-time**: Socket.io for live order updates
- **Deployment**: VPS with PM2 process manager

## Core Features

### Customer Features
- Scan QR code at table to access menu
- Browse dishes with images, descriptions, and prices
- Place orders directly from mobile device
- Real-time order status updates
- View order history

### Admin/Owner Features
- Manage employee accounts
- Manage menu items (dishes)
- Manage tables and QR codes
- View and process orders
- Revenue statistics and reports
- Full system access

### Employee Features
- View and process orders
- Update order status
- View revenue statistics
- Limited system access

## Tech Stack Summary

### Client (Frontend)
- **Framework**: Next.js 15.4.1 (App Router with Turbopack)
- **Language**: TypeScript 5+ (strict mode enabled)
- **Styling**: TailwindCSS 3.4.14 with Tailwind Merge
- **UI Library**: Shadcn UI (built on Radix UI)
- **State Management**: 
  - Zustand 5.0 (global state)
  - Tanstack Query 5.59+ (server state)
- **Forms**: React Hook Form 7.53 + Zod 3.23
- **i18n**: next-intl 4.1 (Vietnamese + English)
- **Real-time**: Socket.io client 4.8
- **Routing**: Next.js App Router with locale prefix
- **Monitoring**: Sentry Next.js 10.17

### Server (Backend)
- **Framework**: Fastify 4.28 with TypeScript
- **Language**: TypeScript 5.5 (strict mode enabled)
- **ORM**: Prisma 5.16 (SQLite database)
- **Validation**: Zod 3.23 with fastify-type-provider-zod
- **Authentication**: fast-jwt 4.0 (JWT tokens)
- **Security**: bcrypt 5.1, @fastify/helmet, @fastify/cors
- **Real-time**: Socket.io via fastify-socket.io
- **Jobs**: Croner 8.1 (cron scheduler)
- **Monitoring**: Sentry Node.js 10.17

## Project Structure

```
project/
├── .cursor/
│   └── rules/              # AI coding rules (you are here)
├── .github/
│   └── workflows/
│       └── ci-cd.yml       # GitHub Actions CI/CD
├── .husky/
│   ├── pre-commit          # Format + Lint before commit
│   └── commit-msg          # Validate commit message
├── client/                 # Next.js frontend
│   ├── src/
│   │   ├── app/           # App Router pages
│   │   ├── apiRequests/   # API client functions
│   │   ├── components/    # React components
│   │   ├── lib/           # Utilities
│   │   ├── queries/       # Tanstack Query hooks
│   │   ├── schemaValidations/ # Zod schemas
│   │   └── types/         # TypeScript types
│   ├── messages/          # i18n translations
│   ├── public/            # Static assets
│   ├── .prettierrc        # Prettier config
│   └── package.json
├── server/                # Fastify backend
│   ├── src/
│   │   ├── routes/       # API routes
│   │   ├── controllers/  # Business logic
│   │   ├── hooks/        # Auth middleware
│   │   ├── plugins/      # Fastify plugins
│   │   ├── schemaValidations/ # Zod schemas
│   │   ├── utils/        # Helper functions
│   │   ├── jobs/         # Cron jobs
│   │   └── database/     # Prisma client
│   ├── prisma/
│   │   ├── schema.prisma # Database schema
│   │   └── dev.db        # SQLite database
│   ├── dist/             # Compiled JavaScript
│   ├── uploads/          # User uploads
│   ├── .prettierrc       # Prettier config
│   └── package.json
├── docs/
│   └── ai/               # AI DevKit documentation
├── ecosystem.config.js   # PM2 configuration
├── nginx.conf            # Nginx reverse proxy config
├── package.json          # Root workspace config
└── README.md
```

## Authentication & Authorization

### JWT Token Strategy
- **Access Token**: 15 minutes lifetime, stored in localStorage
- **Refresh Token**: 7 days lifetime, stored in localStorage (and httpOnly cookie planned)

### User Roles
```typescript
enum Role {
  Owner = 'Owner',      // Admin - Full system access
  Employee = 'Employee', // Staff - Order management + stats
  Guest = 'Guest'        // Customer - Public access only
}
```

### Auth Flow
1. User logs in with email + password
2. Server validates credentials and returns both tokens
3. Client stores tokens and sets Authorization header
4. Access token expires → Auto refresh using refresh token
5. Refresh token expires → Redirect to login
6. Logout → Clear tokens from client & invalidate on server

## Real-time Communication
- **Technology**: Socket.io (WebSocket protocol)
- **Use Cases**: 
  - Live order updates (kitchen → customer)
  - Order status changes
  - New order notifications to staff
  - Force logout events

## Internationalization
- **Supported Languages**: Vietnamese (vi), English (en)
- **Default Language**: Vietnamese
- **URL Structure**: 
  - Vietnamese: `/vi/login`, `/vi/manage/dashboard`
  - English: `/en/login`, `/en/manage/dashboard`
- **Translation Files**: `client/messages/vi.json`, `client/messages/en.json`

## Development Workflow

### Local Development
```bash
# Terminal 1 - Server
cd server
npm run dev          # Port 4000

# Terminal 2 - Client  
cd client
npm run dev          # Port 3000
```

### Code Quality (Automated)
- **Pre-commit**: Prettier format + ESLint fix (via Husky)
- **Commit message**: Conventional commits validation
- **CI/CD**: Runs on push to `main` branch only

### Build Process
```bash
# Client build
cd client && npm run build    # Creates .next/ folder

# Server build
cd server && npm run build    # Compiles to dist/
```

## Deployment Strategy
- **Target**: VPS (Virtual Private Server)
- **Process Manager**: PM2 (ecosystem.config.js)
- **Web Server**: Nginx (reverse proxy)
- **CI/CD**: GitHub Actions
- **Trigger**: Push or merge to `main` branch
- **Steps**: Lint → Security Scan → Build → Deploy → Restart PM2

## Key Conventions

### Naming
- **Files**: `kebab-case.tsx` (e.g., `user-profile.tsx`)
- **Components**: `PascalCase` (e.g., `UserProfile`)
- **Functions**: `camelCase` (e.g., `getUserProfile`)
- **Constants**: `UPPER_SNAKE_CASE` (e.g., `API_BASE_URL`)
- **Types**: `PascalCase + Type` suffix (e.g., `UserProfileType`)

### Import Paths
Always use path aliases instead of relative imports:
```typescript
// ✅ Good
import { http } from '@/lib/http'
import authApiRequest from '@/apiRequests/auth'

// ❌ Bad
import { http } from '../../lib/http'
import authApiRequest from '../apiRequests/auth'
```

### Code Style
- **No semicolons** (Prettier config)
- **Single quotes** for strings
- **2 spaces** indentation (no tabs)
- **100 char** line length (client), **120 char** (server)
- **Trailing comma**: ES5 style (client), none (server)
- **Arrow functions**: Always use parentheses

## Environment Variables

### Client (.env)
```bash
NEXT_PUBLIC_API_ENDPOINT=http://localhost:4000
NEXT_PUBLIC_URL=http://localhost:3000
SENTRY_AUTH_TOKEN=xxx
SENTRY_ORG=xxx
SENTRY_PROJECT=xxx
```

### Server (.env)
```bash
DATABASE_URL="file:./prisma/dev.db"
JWT_SECRET=your_secret_key
JWT_REFRESH_SECRET=your_refresh_secret_key
PORT=4000
NODE_ENV=development
SENTRY_DSN=xxx
```

## Performance Considerations

### Client Optimizations
- Use Server Components by default (no `'use client'` directive)
- Code splitting with `dynamic()` for large components
- Image optimization via Next.js `<Image>` component
- Minimize client-side JavaScript bundle
- Use `loading.tsx` and `Suspense` for progressive rendering

### Server Optimizations
- Prisma connection pooling
- Database indexes on frequently queried columns
- Response caching for static data
- Efficient database queries (select only needed fields)

## Security Best Practices
1. ✅ Never expose JWT secrets in client code
2. ✅ Validate ALL user inputs with Zod schemas
3. ✅ Use bcrypt for password hashing (10 salt rounds)
4. ✅ Enable Fastify helmet plugin
5. ✅ Configure CORS with specific origins
6. ✅ Rate limiting on sensitive endpoints
7. ✅ SQL injection protection via Prisma ORM
8. ✅ XSS protection via DOMPurify (client-side)

## Testing Strategy
- Unit tests for utilities and helpers
- Integration tests for API endpoints
- E2E tests for critical user flows
- Target: 100% coverage for business logic

## Monitoring & Logging
- **Production Errors**: Sentry (client + server)
- **Application Logs**: Console logs in development
- **Performance**: Next.js analytics
- **Uptime**: Health check endpoint `/api-fastify/healthz`

---

**AI Agent Note**: When coding for this project, always refer to the specific rule files (01-10) for detailed patterns and examples. Follow the established conventions strictly to maintain code consistency.

