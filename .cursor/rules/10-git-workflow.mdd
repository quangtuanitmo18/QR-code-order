# Git Workflow & CI/CD

## Commit Message Convention

### Format: Conventional Commits
```
type(scope): subject

Examples:
feat(client): add user profile page
fix(server): resolve JWT token validation bug
docs(readme): update installation steps
style(client): format code with prettier
refactor(api): simplify auth controller logic
perf(server): optimize database queries
test(client): add login form tests
chore(deps): update dependencies
ci(github): update CI/CD pipeline
build(webpack): update webpack config
revert(client): revert previous commit
```

### Types
- **feat**: New feature
- **fix**: Bug fix
- **docs**: Documentation only changes
- **style**: Code style changes (formatting, semicolons, etc.)
- **refactor**: Code refactoring without changing functionality
- **perf**: Performance improvements
- **test**: Adding or updating tests
- **chore**: Maintenance tasks (deps, config, etc.)
- **ci**: CI/CD changes
- **build**: Build system changes
- **revert**: Revert a previous commit

### Scopes
- **client**: Frontend changes
- **server**: Backend changes
- **api**: API endpoint changes
- **ui**: UI component changes
- **auth**: Authentication/authorization
- **db**: Database schema or queries
- **config**: Configuration changes
- **deps**: Dependency updates

### Examples
```bash
# Feature additions
feat(client): add dish filtering functionality
feat(server): implement order status webhook
feat(api): add pagination to orders endpoint

# Bug fixes
fix(client): resolve infinite scroll bug
fix(server): fix JWT token expiration issue
fix(auth): correct permission check logic

# Documentation
docs(readme): add setup instructions
docs(api): document new endpoints

# Refactoring
refactor(client): extract form logic to custom hook
refactor(server): simplify error handling

# Performance
perf(db): add indexes to frequently queried tables
perf(client): optimize image loading

# Testing
test(client): add unit tests for auth hooks
test(server): add integration tests for orders API

# Chores
chore(deps): update Next.js to 15.4.1
chore(config): update ESLint rules
```

## Branch Strategy

### Main Branches
- **`main`**: Production-ready code
  - Protected branch
  - CI/CD runs on push
  - Deploys to production automatically
  - Requires pull request for changes

- **`develop`** (optional): Development branch
  - Integration branch for features
  - Used for staging/testing

### Feature Branches
```bash
feature/add-user-profile
feature/implement-notifications
feature/dashboard-redesign
```

### Bug Fix Branches
```bash
fix/login-redirect
fix/order-status-update
fix/image-upload-error
```

### Hotfix Branches (for urgent production fixes)
```bash
hotfix/security-vulnerability
hotfix/payment-processing
```

## Git Workflow

### 1. Start New Feature
```bash
# Update main branch
git checkout main
git pull origin main

# Create feature branch
git checkout -b feature/add-dish-filter

# Start coding...
```

### 2. Make Changes & Commit
```bash
# Stage changes
git add .

# Commit with conventional message
# (Husky will auto-format and lint)
git commit -m "feat(client): add dish filter by category"

# If you need to bypass hooks (rarely)
git commit -m "message" --no-verify
```

### 3. Push to Remote
```bash
git push origin feature/add-dish-filter
```

### 4. Create Pull Request
```markdown
## Feature: Add Dish Filter

### Summary
Adds filtering functionality to dish list by category, price, and availability status.

### Changes
- Added filter UI components
- Implemented filter logic with query params
- Updated API to support filtering
- Added tests for filter functionality

### Related Issues
Closes #123

### Screenshots
[If applicable]

### Checklist
- [x] Code follows project standards
- [x] All tests pass
- [x] Documentation updated
- [x] No breaking changes
```

### 5. Code Review & Merge
- Request review from team members
- Address feedback
- Merge to main (squash or merge commit)
- Delete feature branch

## Pre-commit Hooks (Husky)

### Configured Hooks

#### `.husky/pre-commit`
```bash
echo "üîç Running pre-commit checks..."

# Run lint-staged
npx lint-staged

echo "‚úÖ Pre-commit checks passed!"
```

#### `.husky/commit-msg`
```bash
# Validate commit message format
commit_msg=$(cat "$1")

if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .{1,}$"; then
    echo "‚ùå Invalid commit message format!"
    echo ""
    echo "Format: type(scope): subject"
    echo ""
    echo "Examples:"
    echo "  feat(client): add user authentication"
    echo "  fix(server): resolve database connection"
    exit 1
fi

echo "‚úÖ Commit message format is valid"
```

### What Runs Automatically
1. **Prettier** - Formats all staged files
2. **ESLint** - Lints and auto-fixes staged files
3. **Commit message validation** - Ensures conventional format

### Root package.json lint-staged Config
```json
{
  "lint-staged": {
    "client/**/*.{ts,tsx,js,jsx}": [
      "cd client && prettier --write",
      "cd client && eslint --fix"
    ],
    "server/**/*.{ts,js}": [
      "cd server && prettier --write",
      "cd server && eslint --fix"
    ],
    "**/*.{json,md,yml,yaml}": [
      "prettier --write"
    ]
  }
}
```

## CI/CD Pipeline (GitHub Actions)

### Trigger
- **Only runs on `main` branch**
- Push or merge to `main`
- Manual trigger via `workflow_dispatch`

### Pipeline Steps

#### 1. CI Job (Continuous Integration)
```yaml
ci:
  runs-on: ubuntu-22.04
  steps:
    - Checkout code
    - Setup Node.js 20
    - Check for changed files (client/server)
    - Create environment files
    - Install dependencies
    - Lint code (ESLint)
    - Security scan (Snyk SAST/SCA)
    - Build client (Next.js)
    - Build server (TypeScript compile)
    - Package artifacts (if main branch)
    - Upload artifacts
```

#### 2. CD Job (Continuous Deployment)
```yaml
cd:
  runs-on: ubuntu-latest
  needs: ci
  if: success() && github.ref == 'refs/heads/main'
  steps:
    - Download artifacts
    - Upload to VPS via SCP
    - SSH into server
    - Extract files
    - Install dependencies
    - Backup current version
    - Deploy new version
    - Restart PM2 services
    - Health check (optional)
```

### CI/CD File Location
`.github/workflows/ci-cd.yml`

### Environment Secrets (GitHub)
Required secrets in repository settings:
- `CLIENT_ENV_PROD` - Client environment variables
- `SERVER_ENV_PROD` - Server environment variables
- `SSH_HOST` - VPS hostname/IP
- `SSH_USERNAME` - SSH user
- `SSH_PRIVATE_KEY` - SSH private key
- `DEPLOY_PATH` - Deployment directory on server
- `SNYK_TOKEN` - Snyk API token (optional)

## Deployment Process

### Automatic Deployment
1. Merge PR to `main`
2. GitHub Actions triggers
3. CI: Build & test
4. CD: Deploy to VPS
5. PM2 restarts services
6. Deployment complete

### Manual Deployment
```bash
# Trigger from GitHub Actions UI
# Or using GitHub CLI:
gh workflow run ci-cd.yml
```

## .gitignore

### Client
```
# Dependencies
node_modules/
.pnp
.pnp.js

# Build
.next/
out/
dist/
build/

# Cache
.turbo/
.cache/

# Environment
.env
.env*.local

# TypeScript
*.tsbuildinfo
next-env.d.ts

# Logs
npm-debug.log*
yarn-debug.log*

# OS
.DS_Store
*.pem
```

### Server
```
# Dependencies
node_modules/

# Build
dist/

# Environment
.env
.env.local

# Database
*.db
prisma/dev.db

# Uploads
uploads/

# Logs
*.log

# TypeScript
*.tsbuildinfo

# OS
.DS_Store
```

## Best Practices

### Git Commits
1. ‚úÖ **Atomic commits** - One logical change per commit
2. ‚úÖ **Descriptive messages** - Explain what and why
3. ‚úÖ **Small, focused PRs** - Easier to review
4. ‚úÖ **Test before committing** - Ensure code works
5. ‚úÖ **Rebase when needed** - Keep history clean

### Pull Requests
1. ‚úÖ **Link related issues** - Use "Closes #123"
2. ‚úÖ **Add description** - Explain changes
3. ‚úÖ **Request reviews** - Get feedback
4. ‚úÖ **Update branch** - Rebase on main if needed
5. ‚úÖ **Resolve conflicts** - Before merging

### CI/CD
1. ‚úÖ **Fix broken builds** immediately
2. ‚úÖ **Monitor deployments** - Check logs
3. ‚úÖ **Test in staging** first (if available)
4. ‚úÖ **Rollback plan** - Know how to revert
5. ‚úÖ **Keep secrets secure** - Never commit

## Troubleshooting

### Pre-commit Hook Fails
```bash
# Check what failed
git commit -m "message"

# Fix issues manually
npm run prettier:fix
npm run lint:fix

# Try again
git add .
git commit -m "message"

# Or bypass if necessary (not recommended)
git commit -m "message" --no-verify
```

### CI/CD Pipeline Fails
1. Check GitHub Actions logs
2. Common issues:
   - Linting errors
   - Build errors
   - Missing environment variables
   - Dependency issues
3. Fix locally and push again

### Merge Conflicts
```bash
# Update your branch
git checkout feature/your-branch
git fetch origin
git rebase origin/main

# Resolve conflicts in editor
# Stage resolved files
git add .

# Continue rebase
git rebase --continue

# Force push (if already pushed)
git push --force-with-lease
```

## Commands Cheat Sheet

```bash
# View status
git status

# View commit history
git log --oneline --graph

# Undo last commit (keep changes)
git reset --soft HEAD~1

# Discard local changes
git checkout -- <file>

# Update branch from main
git checkout main && git pull
git checkout feature-branch
git rebase main

# Squash commits before PR
git rebase -i HEAD~3

# Delete local branch
git branch -d feature-branch

# Delete remote branch
git push origin --delete feature-branch

# View diff
git diff
git diff --staged
```

## Release Process (if needed)

1. Update version in package.json
2. Create release branch: `release/v1.2.0`
3. Update CHANGELOG.md
4. Merge to main
5. Create GitHub release with tag
6. Deploy automatically via CI/CD

